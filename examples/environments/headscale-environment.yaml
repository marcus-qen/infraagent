apiVersion: legator.io/v1alpha1
kind: LegatorEnvironment
metadata:
  name: enterprise-servers
  namespace: agents
spec:
  description: "Enterprise server management via Headscale mesh VPN"

  # Network connectivity â€” Headscale mesh VPN
  connectivity:
    type: headscale
    headscale:
      controlServer: "https://headscale.example.com"
      authKeySecretRef: headscale-auth-key
      tags:
        - "tag:agent-runtime"
      hostname: legator-controller
      acceptRoutes: true

  # Vault for dynamic credentials
  vault:
    address: "https://vault.example.com"
    authMethod: kubernetes
    k8sAuthRole: legator-agents
    k8sAuthPath: auth/kubernetes

  credentials:
    # SSH access to managed servers via Vault CA
    linux-servers:
      type: vault-ssh-ca
      vault:
        mount: ssh-client-signer
        role: agent-readonly
        ttl: "5m"

    # Database access via Vault dynamic credentials
    app-database:
      type: vault-database
      vault:
        mount: database
        role: readonly-app
        ttl: "10m"

    # GitHub API token from Vault KV
    github-pat:
      type: vault-kv
      vault:
        mount: secret
        path: agents/github-pat

  endpoints:
    # Servers reachable via Headscale mesh
    centos-proxy:
      url: "ssh://centos7-proxy-01.example.ts.net:22"
      healthPath: ""
    ubuntu-app:
      url: "ssh://ubuntu-app-03.example.ts.net:22"
      healthPath: ""

    # Database reachable via subnet router
    postgres-prod:
      url: "tcp://10.20.5.100:5432"
      healthPath: ""

    # Internal K8s services (direct)
    grafana:
      url: "http://grafana.monitoring:3000"
      healthPath: "/api/health"
      internal: true
    prometheus:
      url: "http://prometheus-operated.monitoring:9090"
      healthPath: "/-/healthy"
      internal: true

---
# Headscale pre-authentication key
apiVersion: v1
kind: Secret
metadata:
  name: headscale-auth-key
  namespace: agents
type: Opaque
stringData:
  # Pre-auth key generated via: headscale preauthkeys create --user legator --expiration 8760h
  key: "hskey-auth-EXAMPLE-REPLACE-ME"
