apiVersion: legator.io/v1alpha1
kind: LegatorEnvironment
metadata:
  name: database-monitoring
  namespace: agents
spec:
  description: "Database monitoring environment with Vault-issued ephemeral credentials"

  vault:
    address: "http://vault.vault:8200"
    authMethod: kubernetes
    k8sAuthRole: legator-agents
    k8sAuthPath: auth/kubernetes

  credentials:
    # Dynamic PostgreSQL credentials via Vault database secrets engine
    app-database:
      type: vault-database
      vault:
        mount: database
        role: readonly-app
        ttl: "10m"
      # After Vault credential injection, the following keys will be populated:
      # username, password (dynamically generated)
      # The buildSQLDatabases function also needs driver, host, port, dbname
      secretRef: app-database-config  # Static config (driver, host, port, dbname)

    # Static database credentials (for databases not in Vault)
    metrics-database:
      type: basic-auth
      secretRef: metrics-db-creds

  endpoints:
    app-postgres:
      url: "postgres.app-system:5432"
    metrics-postgres:
      url: "postgres.monitoring:5432"

---
# Static config for the app database (non-secret connection details)
apiVersion: v1
kind: Secret
metadata:
  name: app-database-config
  namespace: agents
stringData:
  driver: postgres
  host: postgres.app-system
  port: "5432"
  dbname: app
  sslmode: require

---
# Static credentials for metrics database
apiVersion: v1
kind: Secret
metadata:
  name: metrics-db-creds
  namespace: agents
stringData:
  driver: postgres
  host: postgres.monitoring
  port: "5432"
  dbname: metrics
  username: readonly_agent
  password: changeme  # In production, use Vault or ESO
  sslmode: require
